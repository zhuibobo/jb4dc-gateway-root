<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>Title</title><title>JBuild4D</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script type="text/javascript" src="../../../../Js/External/JQuery-3.6.0/jquery-3.6.0.min.js"></script><script type="text/javascript" src="../../../../Js/External/VUE-2.6.10/vue.js"></script><script type="text/javascript" src="../../../../Js/External/IView-4.X/dist/iview.min.js"></script><script type="text/javascript" src="../../../../Js/External/JQuery-UI-1.13.0/jquery-ui.js"></script><script type="text/javascript" src="../../../../Js/External/ZTree-3.5.40/js/jquery.ztree.all.js"></script><script type="text/javascript" src="../../../../Js/External/Perfect-Scrollbar-V1.4.0/perfect-scrollbar.js"></script><script type="text/javascript" src="../../../../Js/JBuild4DCLib.js?refVersion=1650644464560"></script><script type="text/javascript" src="../../../../Js/UIEXComponent.js?refVersion=1650644464560"></script><script type="text/javascript" src="../../../../Js/VueEXComponent.js?refVersion=1650644464560"></script><script type="text/javascript" src="../../../../JB4DCBuilder/Js/UIEXComponentForBuilder.js?refVersion=1650644464560"></script><script type="text/javascript" src="../../../../JB4DCBuilder/Js/BuilderVueEXComponent.js?refVersion=1650644464560"></script><script type="text/javascript" src="../../../../SSOSystem/Js/SSOVueEXComponent.js?refVersion=1650644464560"></script><link rel="stylesheet" type="text/css" href="../../../../Themes/Default/IView-4.X/iview.css"><link rel="stylesheet" type="text/css" href="../../../../Themes/Default/JQueryUI/jquery-ui.css"><link rel="stylesheet" type="text/css" href="../../../../Themes/Default/JQueryUI/jquery-ui-important.css"><link rel="stylesheet" type="text/css" href="../../../../Js/External/Perfect-Scrollbar-V1.4.0/perfect-scrollbar.css"><link rel="stylesheet" type="text/css" href="../../../../Themes/Default/ZTree/zTreeStyle/zTreeStyle.css"><link rel="stylesheet" type="text/css" href="../../../../Themes/Default/Css/JBuild4DC.css?refVersion=1650644464560"><link rel="stylesheet" type="text/css" href="../../../../JB4DCBuilder/Themes/Default/Css/JBuild4DCBuilder.css?refVersion=1650644464560"></head><body><div id="dataSetEditForm" v-cloak class="general-edit-page-wrap"><spin size="large" fix v-if="isSubmitting"></spin><div class="list-2column"><div class="left-outer-wrap" style="bottom:50px;right:350px"><div style="width:98%;margin:auto"><tabs v-model="datasetEntity.dsType"><tab-pane label="SQL数据集" name="SQLDataSet"><div style="width:100%;height:60px"><div style="float:left;width:86%;border:#2c77d6 1px solid;border-radius:4px;height:50px;padding:4px;overflow:auto">{{datasetEntity.dsSqlSelectText}}</div><div @click="designSQL" style="color:#fff;background-color:#47cb89;float:left;width:5%;border:red 1px solid;border-radius:4px;height:50px;text-align:center;line-height:50px;margin-left:10px;cursor:pointer">编辑</div><div style="float:left;width:5%;border:#2c77d6 1px solid;border-radius:4px;height:50px;text-align:center;line-height:50px;margin-left:10px;cursor:pointer">预览</div></div></tab-pane><tab-pane label="API数据集" name="APIDataSet"><div style="width:100%;height:30px" name="APIDataSetInnerWraper"><i-input v-model="datasetEntity.dsClassName" search enter-button="加载" @on-search="loadApiDataSetVo"><span slot="prepend">类全称[继承com.jbuild4d.platform.builder.extend.IDataSetAPI]：</span></i-input></div></tab-pane><tab-pane label="REST数据集" name="RESTDataSet"><div style="width:100%;height:60px"><i-input size="small" v-model="datasetEntity.dsRestStructureUrl" search enter-button="加载" @on-search="loadRestDataSetVo"><span slot="prepend">获取结构URL：</span></i-input><i-input style="margin-top:4px" size="small" v-model="datasetEntity.dsRestDataUrl" search enter-button="测试" @on-search="testRestDataSetVo"><span slot="prepend">数据提供URL：</span></i-input></div></tab-pane><tab-pane label="自定义数据集" name="CUSTOMDataSet"></tab-pane></tabs><div style="width:70%;float:left;margin-right:10px"><div style="width:100%"><div style="float:right;margin-bottom:8px">编辑列 &nbsp;<button-group><i-button size="small" type="success" icon="md-add" @click="addColumn"></i-button><i-button size="small" type="primary" icon="md-close" @click="removeColumn"></i-button><i-button size="small" type="primary" icon="ios-arrow-up" @click="moveColumn('up')"></i-button><i-button size="small" type="primary" icon="ios-arrow-down" @click="moveColumn('down')"></i-button><i-button size="small" type="primary" icon="md-trash" @click="clearColumn()"></i-button></button-group></div><div style="clear:bottom"></div></div><div id="divEditTable" class="edit-table-wrap" style="height:100px;overflow:auto;width:100%"></div></div><div style="width:28%;float:left"><div style="height:22px;margin-bottom:8px;line-height:22px;padding-right:10px"><div style="float:right">相关表</div></div><div id="divRelatedTable" class="edit-table-wrap" style="height:100px;overflow:auto;width:100%"></div></div></div></div><div class="right-outer-wrap" style="bottom:50px;width:340px;padding:10px;overflow-y:auto;overflow-x:hidden"><divider orientation="left" :dashed="true" style="font-size:12px;padding:10px">数据集信息</divider><i-form :model="datasetEntity" :rules="ruleValidate" :label-width="90" style="margin-right:10px"><form-item label="标题：" prop="dsCaption"><i-input v-model="datasetEntity.dsCaption"></i-input></form-item><form-item label="名称：" prop="dsName"><i-input v-model="datasetEntity.dsName"></i-input></form-item><form-item label="创建人："><row><i-col span="6"><i-input v-model="datasetEntity.dsCreator"></i-input></i-col><i-col span="8" style="text-align:center">创建时间：</i-col><i-col span="10"><form-item><date-picker type="date" placeholder="选择创建时间" v-model="datasetEntity.dsCreateTime" disabled="disabled" readonly="readonly" style="width:100%"></date-picker></form-item></i-col></row></form-item><form-item label="修改人："><row><i-col span="6"><i-input v-model="datasetEntity.dsUpdater"></i-input></i-col><i-col span="8" style="text-align:center">修改时间：</i-col><i-col span="10"><form-item><date-picker type="date" placeholder="选择创建时间" v-model="datasetEntity.dsUpdateTime" disabled="disabled" readonly="readonly" style="width:100%"></date-picker></form-item></i-col></row></form-item><form-item label="系统表："><i-input v-model="datasetEntity.dsIsSystem" readonly="readonly"></i-input></form-item><form-item label="备注："><i-input v-model="datasetEntity.dsDesc" type="textarea" :autosize="{minRows: 17,maxRows: 17}"></i-input></form-item><form-item label="连接："><i-input v-model="datasetEntity.dsSqlDbLinkId" :disabled="true"></i-input></form-item></i-form></div></div><div class="button-outer-wrap"><div class="button-inner-wrap"><button-group><i-button type="primary" @click="saveEditDataSet()">保 存</i-button><i-button @click="handleClose()">关 闭</i-button></button-group></div></div></div><script>var dataSetEditForm=new Vue({el:"#dataSetEditForm",data:{isSubmitting:!1,acInterface:{getDataUrl:"/Rest/Builder/DataSet/DataSetMain/GetDataSetData",saveDataUrl:"/Rest/Builder/DataSet/DataSetMain/SaveDataSetEdit",loadApiDataUrl:"/Rest/Builder/DataSet/DataSetMain/GetApiDataSetVoStructure"},currUserEntity:null,ruleValidate:{dsCaption:[{required:!0,message:"【标题】不能空！",trigger:"blur"}]},datasetEntity:{dsId:"",dsCaption:"",dsName:"",dsCreateTime:DateUtility.GetCurrentDate(),dsCreator:"",dsUpdateTime:DateUtility.GetCurrentDate(),dsUpdater:"",dsType:"",dsIsSystem:"否",dsDesc:"",dsGroupId:"",dsStatus:"启用",dsSqlSelectText:"",dsSqlSelectValue:"",dsClassName:"",dsRestStructureUrl:"",dsRestDataUrl:"",columnVoList:null,relatedTableVoList:null,dsSqlDbLinkId:""},editTableObj:null,editTableConfig:{Status:"Edit",DataField:"fieldName",Templates:[{Title:"字段ID",BindName:"columnId",Renderer:"EditTable_Label",TitleCellClassName:"TitleCell",DefaultValue:{Type:"GUID",Value:0},Hidden:!0},{Title:"标题",BindName:"columnCaption",Renderer:"EditTable_TextBox",TitleCellClassName:"TitleCell",Validate:{Type:"NotEmpty"},Hidden:!1,TitleCellAttrs:{},Style:{width:150}},{Title:"名称",BindName:"columnName",Renderer:"EditTable_FieldName",Validate:{Type:"SQLKeyWord"},DefaultValue:{Type:"Const",Value:"F_"},Style:{width:150},Hidden:!1},{Title:"字段类型",BindName:"columnDataTypeName",Renderer:"Column_SelectFieldType",Hidden:!1,Style:{width:68,textAlign:"center"}},{Title:"自定义",BindName:"columnIsCustom",Renderer:"EditTable_Label",Style:{width:80,textAlign:"center"},DefaultValue:{Type:"Const",Value:"是"},Hidden:!1},{Title:"备注",BindName:"columnDesc",Renderer:"EditTable_TextBox",Hidden:!1,Style:{width:180,textAlign:"center"}},{Title:"格式化方法",BindName:"columnFormatter",Renderer:"EditTable_TextBox",Hidden:!1},{Title:"默认值",BindName:"columnDefaultValue",Renderer:"Column_SelectDefaultValue",Hidden:!1,Style:{width:220}}],RowIdCreater:function(){},TableClass:"edit-table",RendererTo:"divEditTable",TableId:"dsColumns",TableAttrs:{cellpadding:"1",cellspacing:"1",border:"1"}},status:BaseUtility.GetUrlParaValue("op"),relatedEditTableObj:null,relatedEditTableConfig:{Status:"Edit",DataField:"fieldName",Templates:[{Title:"表名ID",BindName:"rtTableId",Renderer:"EditTable_Label",TitleCellClassName:"TitleCell",Validate:{Type:"NotEmpty"},Hidden:!0},{Title:"表名",BindName:"rtTableName",Renderer:"EditTable_Label",TitleCellClassName:"TitleCell",Hidden:!1,Validate:{Type:"NotEmpty"},Style:{width:180}},{Title:"标题",BindName:"rtTableCaption",Renderer:"EditTable_TextBox",TitleCellClassName:"TitleCell",Validate:{Type:"NotEmpty"},Hidden:!1,TitleCellAttrs:{}},{Title:"主表",BindName:"rtTableIsMain",Renderer:"Column_RTTableIsMain",TitleCellClassName:"TitleCell",Hidden:!1,TitleCellAttrs:{}}],RowIdCreater:function(){},TableClass:"edit-table",RendererTo:"divRelatedTable",TableId:"relatedEditTableObj",TableAttrs:{cellpadding:"1",cellspacing:"1",border:"1"}}},mounted:function(){this.editTableObj=Object.create(EditTable),this.editTableObj.Initialization(this.editTableConfig),this.relatedEditTableObj=Object.create(EditTable),this.relatedEditTableObj.Initialization(this.relatedEditTableConfig),this.currUserEntity=SessionUtility.GetSessionUserSync(),"add"==this.status?(this.datasetEntity.dsCreator=this.currUserEntity.userName,this.datasetEntity.dsUpdater=this.currUserEntity.userName,this.datasetEntity.dsId=StringUtility.Guid(),this.datasetEntity.dsGroupId=BaseUtility.GetUrlParaValue("groupId"),this.datasetEntity.dsType="SQLDataSet",this.datasetEntity.dsSqlSelectText="请编辑SQL"):(this.datasetEntity.dsId=BaseUtility.GetUrlParaValue("recordId"),this.datasetEntity.dsUpdater=this.currUserEntity.userName,this.loadData(this.datasetEntity.dsId,this.status)),$("#divEditTable").height($(".right-outer-wrap").height()-185)},created:function(){},methods:{loadData:function(t,e){var a=this;AjaxUtility.Post(this.acInterface.getDataUrl,{recordId:t,op:e},function(t){t.success?(console.log(t),a.datasetEntity=t.data,a.editTableObj.LoadJsonData(a.datasetEntity.columnVoList),a.relatedEditTableObj.LoadJsonData(a.datasetEntity.relatedTableVoList),"view"==e&&DetailPageUtility.IViewPageToViewStatus(),"APIDataSet"==a.datasetEntity.dsType&&window.setTimeout(function(){$("[name='APIDataSetInnerWraper']").css("visibility","visible")},500)):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,null)},this)},addColumn:function(){this.editTableObj.AddEditingRowByTemplate()},removeColumn:function(){this.editTableObj.RemoveRow()},clearColumn:function(){this.editTableObj.RemoveAllRow()},moveColumn:function(t){"up"==t?this.editTableObj.MoveUp():this.editTableObj.MoveDown()},saveEditDataSet:function(){if(""==this.datasetEntity.dsCaption.replace(/(^\s*)|(\s*$)/g,""))return DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},"数据集标题不能为空!",null),!1;if(this.editTableObj.CompletedEditingRow()&&this.relatedEditTableObj.CompletedEditingRow()){if(this.datasetEntity.columnVoList=this.editTableObj.GetSerializeJson(),this.datasetEntity.relatedTableVoList=this.relatedEditTableObj.GetSerializeJson(),console.log(this.datasetEntity.columnVoList),console.log(this.datasetEntity.relatedTableVoList),this.datasetEntity.columnVoList)for(var t=0;t<this.datasetEntity.columnVoList.length;t++)""!=this.datasetEntity.columnVoList[t].columnId&&null!=this.datasetEntity.columnVoList[t].columnId||(this.datasetEntity.columnVoList[t].columnId=StringUtility.Guid());if(this.datasetEntity.relatedTableVoList)for(t=0;t<this.datasetEntity.relatedTableVoList.length;t++)""!=this.datasetEntity.relatedTableVoList[t].rtId&&null!=this.datasetEntity.relatedTableVoList[t].rtId||(this.datasetEntity.relatedTableVoList[t].rtId=StringUtility.Guid());var e={op:this.status,dataSetId:this.datasetEntity.dsId,dataSetVoJson:JSON.stringify(this.datasetEntity)};this.isSubmitting=!0,AjaxUtility.Post(this.acInterface.saveDataUrl,e,function(t){DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,function(){t.success&&(window.OpenerWindowObj.appList&&"function"==typeof window.OpenerWindowObj.appList.reloadData&&window.OpenerWindowObj.appList.reloadData(),window.OpenerWindowObj._modulelistweblistcomp&&"function"==typeof window.OpenerWindowObj._modulelistweblistcomp.reloadData&&window.OpenerWindowObj._modulelistweblistcomp.reloadData(),DialogUtility.Frame_CloseDialog(window))})},this)}},handleClose:function(){DialogUtility.Frame_CloseDialog(window)},designSQL:function(){var t=BaseUtility.BuildView("/HTML/Builder/DataSet/SQLDesigner.html",{}),e=690;PageStyleUtility.GetPageHeight()<600&&(e=500),DialogUtility.OpenIframeWindow(window,DialogUtility.DialogId,t,{title:"编辑SQL语句",modal:!0,height:e,width:980})},completedSQLDesign:function(t){if(console.log(t),this.datasetEntity.dsSqlSelectText=t.data.sqlWithEnvText,this.datasetEntity.dsSqlSelectValue=t.data.sqlWithEnvValue,this.datasetEntity.dsSqlDbLinkId=t.data.dataSetPO.dsSqlDbLinkId,this.relatedEditTableObj.RemoveAllRow(),this.relatedEditTableObj.LoadJsonData(t.data.dataSetPO.relatedTableVoList),this.editTableObj.CompletedEditingRow()){var e=this.editTableObj.GetSerializeJson();if(0==e.length)this.editTableObj.LoadJsonData(t.data.dataSetPO.columnVoList);else{for(var a=this.editTableObj.GetSerializeJson(),i=0;i<t.data.dataSetPO.columnVoList.length;i++){for(var l=t.data.dataSetPO.columnVoList[i].columnName,d=!0,s=0;s<e.length;s++){if(e[s].columnName==l){d=!1;break}}d&&a.push(t.data.dataSetPO.columnVoList[i])}this.editTableObj.RemoveAllRow(),this.editTableObj.LoadJsonData(a)}}},loadApiDataSetVo:function(){var e=this,t=this.datasetEntity.dsId,a=this.status,i=this.datasetEntity.dsGroupId,l=this.datasetEntity.dsClassName;AjaxUtility.Post(this.acInterface.loadApiDataUrl,{recordId:t,op:a,groupId:i,fullClassName:l},function(t){t.success?(e.clearColumn(),e.datasetEntity.dsCaption=t.data.dsCaption,e.datasetEntity.dsName=t.data.dsName,e.editTableObj.LoadJsonData(t.data.columnVoList),e.relatedTable.data=t.data.relatedTableVoList):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,null)},this)},loadRestDataSetVo:function(){},testRestDataSetVo:function(){}}})</script></body></html>